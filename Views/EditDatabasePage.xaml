<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:AMK.Models.ViewModels"
             x:Class="AMK.Views.EditDatabasePage"
             Title="Ð¡Ð¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸ÐºÐ¸"
             BackgroundColor="{StaticResource AppBackground}">

    <Grid RowDefinitions="Auto,*">

        <!-- Top controls -->
        <Grid Padding="16,12" ColumnDefinitions="*,Auto" ColumnSpacing="12">
            <SearchBar Grid.Column="0"
                       Placeholder="ÐŸÐ¾Ð¸ÑÐº Ð¿Ð¾ Ð¤Ð˜Ðž/Ð»Ð¾Ð³Ð¸Ð½Ñƒ"
                       Text="{Binding SearchText}"
                       SearchCommand="{Binding SearchCommand}"
                       BackgroundColor="White" />

            <Button Grid.Column="1"
                    Text="+"
                    Style="{StaticResource PrimaryButton}"
                    WidthRequest="44"
                    HeightRequest="44"
                    Command="{Binding NewUserCommand}" />
        </Grid>

        <!-- Users list -->
        <RefreshView Grid.Row="1"
                     IsRefreshing="{Binding IsLoading}"
                     Command="{Binding RefreshCommand}">

            <CollectionView ItemsSource="{Binding Users}"
                            SelectionMode="None">
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Frame Style="{StaticResource CardFrame}" Margin="16,8" Padding="12">
                            <Grid ColumnDefinitions="*,Auto,Auto" RowDefinitions="Auto,Auto" ColumnSpacing="10" RowSpacing="4">

                                <StackLayout Grid.Column="0" Grid.RowSpan="2" Spacing="2">
                                    <Label Text="{Binding FIO}" FontAttributes="Bold" FontSize="16" TextColor="{StaticResource TextPrimary}" />
                                    <Label Text="{Binding Login, StringFormat='Ð›Ð¾Ð³Ð¸Ð½: {0}'}" FontSize="12" TextColor="{StaticResource Gray600}" />
                                    <Label Text="{Binding RoleDetail.Title, StringFormat='Ð Ð¾Ð»ÑŒ: {0}'}" FontSize="12" TextColor="{StaticResource Gray600}" />
                                    <Label Text="{Binding DepartmentDetail.DepartmentName, StringFormat='ÐžÑ‚Ð´ÐµÐ»: {0}'}" FontSize="12" TextColor="{StaticResource Gray600}" />
                                </StackLayout>

                                <Button Grid.Column="1" Grid.Row="0"
                                        Text="âœï¸"
                                        Style="{StaticResource SecondaryButton}"
                                        Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:UsersViewModel}}, Path=EditUserCommand}"
                                        CommandParameter="{Binding .}" />

                                <Button Grid.Column="2" Grid.Row="0"
                                        Text="ðŸ—‘ï¸"
                                        Style="{StaticResource DangerButton}"
                                        Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:UsersViewModel}}, Path=DeleteUserCommand}"
                                        CommandParameter="{Binding .}" />

                                <StackLayout Grid.Column="1" Grid.ColumnSpan="2" Grid.Row="1" Spacing="2">
                                    <Label Text="{Binding Email, StringFormat='ðŸ“§ {0}'}" FontSize="12" TextColor="{StaticResource Gray500}" />
                                    <Label Text="{Binding Phone, StringFormat='ðŸ“± {0}'}" FontSize="12" TextColor="{StaticResource Gray500}" />
                                </StackLayout>

                            </Grid>
                        </Frame>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </RefreshView>

        <!-- Edit sheet -->
        <Grid IsVisible="{Binding IsEditing}" BackgroundColor="#80000000" Padding="16" RowDefinitions="*" ColumnDefinitions="*">
            <Frame Style="{StaticResource CardFrame}" Padding="16" VerticalOptions="Center" HorizontalOptions="Center" WidthRequest="340">
                <ScrollView>
                    <StackLayout Spacing="10">
                        <Label Text="{Binding SelectedUser.ID_user, StringFormat='ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ #{0}'}"
                               FontAttributes="Bold"
                               FontSize="16"
                               TextColor="{StaticResource TextPrimary}" />

                        <Entry Placeholder="Ð¤Ð˜Ðž*" Text="{Binding SelectedUser.FIO}" />
                        <Entry Placeholder="Ð›Ð¾Ð³Ð¸Ð½*" Text="{Binding SelectedUser.Login}" />
                        <Entry Placeholder="ÐŸÐ°Ñ€Ð¾Ð»ÑŒ*" Text="{Binding SelectedUser.Password}" IsPassword="True" />

                        <Entry Placeholder="Email" Text="{Binding SelectedUser.Email}" Keyboard="Email" />
                        <Entry Placeholder="+7 (999) 999-99-99" Text="{Binding SelectedUser.Phone}" Keyboard="Telephone"/>

                        <DatePicker Date="{Binding SelectedUser.Birthday}" />

                        <Picker Title="Ð Ð¾Ð»ÑŒ" ItemsSource="{Binding Roles}" ItemDisplayBinding="{Binding Title}" SelectedItem="{Binding SelectedRole}" />
                        <Picker Title="ÐžÑ‚Ð´ÐµÐ»" ItemsSource="{Binding Departments}" ItemDisplayBinding="{Binding DepartmentName}" SelectedItem="{Binding SelectedDepartment}" />

                        <Grid ColumnDefinitions="*,*" ColumnSpacing="10">
                            <Button Grid.Column="0" Text="ÐžÑ‚Ð¼ÐµÐ½Ð°" Style="{StaticResource SecondaryButton}" Command="{Binding CancelEditCommand}" />
                            <Button Grid.Column="1" Text="Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ" Style="{StaticResource PrimaryButton}" Command="{Binding SaveUserCommand}" />
                        </Grid>

                    </StackLayout>
                </ScrollView>
            </Frame>
        </Grid>

    </Grid>
</ContentPage>
